<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiber Fault Locator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
    }
    #map {
        height: 100vh;
        width: 100%;
    }
    .top-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.85);
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 14px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    input, select, button {
        padding: 6px;
        font-size: 14px;
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
    <input type="file" id="fileInput" accept=".kml,.kmz">
    <select id="referencePoint">
        <option value="A">Point A</option>
        <option value="B">Point B</option>
    </select>
    <input type="number" id="otdrDistance" placeholder="OTDR Distance (m)">
    <button onclick="locateFault()">Locate Fault</button>
</div>

<script>
let map = L.map('map').setView([14.5995, 120.9842], 13); // Manila default
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let routeCoords = [];
let polyline;
let pointA, pointB;

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    if (file.name.endsWith('.kmz')) {
        JSZip.loadAsync(file).then(zip => {
            const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
            zip.files[kmlFile].async('string').then(kmlText => {
                processKML(kmlText);
            });
        });
    } else {
        reader.onload = e => processKML(e.target.result);
        reader.readAsText(file);
    }
}

function processKML(kmlText) {
    const parser = new DOMParser();
    const kml = parser.parseFromString(kmlText, 'text/xml');
    const geojson = toGeoJSON.kml(kml);

    if (polyline) map.removeLayer(polyline);

    routeCoords = geojson.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
    polyline = L.polyline(routeCoords, { color: 'blue', weight: 4 }).addTo(map);
    map.fitBounds(polyline.getBounds());

    let startCoord = routeCoords[0];
    let endCoord = routeCoords[routeCoords.length - 1];

    if (pointA) map.removeLayer(pointA);
    if (pointB) map.removeLayer(pointB);

    pointA = L.marker(startCoord).addTo(map).bindPopup("Point A");
    pointB = L.marker(endCoord).addTo(map).bindPopup("Point B");
}

function locateFault() {
    let distance = parseFloat(document.getElementById('otdrDistance').value);
    if (isNaN(distance) || routeCoords.length === 0) return alert("Please upload a route and enter a valid distance.");

    let ref = document.getElementById('referencePoint').value;
    let coords = (ref === 'A') ? routeCoords : [...routeCoords].reverse();

    let totalDist = 0;
    for (let i = 0; i < coords.length - 1; i++) {
        let segDist = map.distance(coords[i], coords[i + 1]);
        if (totalDist + segDist >= distance) {
            let ratio = (distance - totalDist) / segDist;
            let lat = coords[i][0] + (coords[i + 1][0] - coords[i][0]) * ratio;
            let lng = coords[i][1] + (coords[i + 1][1] - coords[i][1]) * ratio;

            L.marker([lat, lng], { icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            }) }).addTo(map).bindPopup("Approx. Fault Location").openPopup();
            return;
        }
        totalDist += segDist;
    }
    alert("Distance exceeds route length.");
}
</script>

</body>
</html>
